[åŸæ–‡é“¾æ¥](https://juejin.cn/post/7237439385909592122?searchId=20240226122602E689EE2FACE0E63D4DAE)
## äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ï¼Ÿ
äº‹åŠ¡æ˜¯ä¸€ç§ç”¨äºç®¡ç†æ•°æ®åº“æ“ä½œçš„æœºåˆ¶ã€‚å®ƒå°†ä¸€ç»„æ“ä½œå°è£…æˆä¸€ä¸ªå•å…ƒï¼Œç¡®ä¿æ•°æ®åº“æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸæäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Œä»¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨äº‹åŠ¡å‘¢ï¼Ÿè¯·çœ‹ä¸‹é¢çš„æ¡ˆä¾‹ã€‚

å‡è®¾æœ‰ä¸¤ä¸ªç”¨æˆ·çš„é“¶è¡Œè´¦æˆ·ï¼Œè´¦æˆ·Aå’Œè´¦æˆ·Bï¼Œå®ƒä»¬åˆ†åˆ«å­˜å‚¨ç€ä¸€å®šçš„é‡‘é¢ã€‚ç°åœ¨ï¼Œç”¨æˆ·Aæƒ³è¦å‘ç”¨æˆ·Bè½¬è´¦100å…ƒã€‚è¿™ä¸ªè½¬è´¦æ“ä½œéœ€è¦ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š

1. ä»ç”¨æˆ·Açš„è´¦æˆ·ä¸­æ‰£é™¤100å…ƒã€‚
2. å°†æ‰£é™¤çš„100å…ƒæ·»åŠ åˆ°ç”¨æˆ·Bçš„è´¦æˆ·ä¸­ã€‚
åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ä¸¤ä¸ªæ­¥éª¤è¦ä¹ˆåŒæ—¶æˆåŠŸæäº¤ï¼Œè¦ä¹ˆåŒæ—¶å›æ»šã€‚å¦‚æœç¬¬ä¸€æ­¥æ‰§è¡ŒæˆåŠŸäº†ï¼Œç¬¬äºŒæ­¥å´æ‰§è¡Œå¤±è´¥äº†ï¼Œé‚£ä¹ˆBæ²¡æœ‰æ”¶åˆ°è¿™100å—é’±ï¼ŒAçš„é’±å°±ä¸ç¿¼è€Œé£äº†ã€‚æ‰€ä»¥å¦‚æœå…¶ä¸­ä¸€ä¸ªæ­¥éª¤å‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»å›æ»šæ•´ä¸ªäº‹åŠ¡ï¼Œä»¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚

## Springä¸­äº‹åŠ¡çš„å®ç°

### ç¼–ç¨‹å¼äº‹åŠ¡
Spring Bootä¸­å†…ç½®äº†ä¸¤ä¸ªå¯¹è±¡ï¼Œå³ï¼š`DataSourceTransactionManager`ä¸ `TransactionDefinition`ï¼Œç”¨è¿™ä¸¤ä¸ªå¯¹è±¡å°±å¯ä»¥æ¥æ“ä½œäº‹åŠ¡äº†ã€‚

è¿™é‡Œå·²ç»é…ç½®äº†ç›¸åº”çš„æ•°æ®åº“ç¯å¢ƒ
```java
@RestController
@RequestMapping("/user")
public class UserController {

    @Autowired
    private UserService userService;

    //DataSourceTransactionManager: æ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨
    @Autowired
    private DataSourceTransactionManager dataSourceTransactionManager;

	//TransactionDefinitionï¼šäº‹åŠ¡å®šä¹‰    
    @Autowired
    private TransactionDefinition transactionDefinition;

    //æ ¹æ® id åˆ é™¤æ•°æ®
    @RequestMapping("/delete")
    public Integer delete(Integer id){
        //å¼€å¯äº‹åŠ¡
        TransactionStatus transactionStatus = dataSourceTransactionManager.getTransaction(transactionDefinition);

        //å¯¹æ•°æ®åº“æ“ä½œï¼šåˆ é™¤
        Integer result = userService.delete(1);

        //æäº¤äº‹åŠ¡ or å›æ»šäº‹åŠ¡
        //å›æ»šäº‹åŠ¡
        dataSourceTransactionManager.rollback(transactionStatus);
        //æäº¤äº‹åŠ¡
        //dataSourceTransactionManager.commit(transactionStatus);
        return result;
    }
```
- ä½¿ç”¨`DataSourceTransactionManager`çš„`getTransaction`æ–¹æ³•å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ã€‚
- åœ¨`getTransaction`æ–¹æ³•ä¸­ä¼ é€’ä¸€ä¸ª`TransactionDefinition`å¯¹è±¡æ¥å®šä¹‰äº‹åŠ¡çš„å±æ€§ã€‚
- `getTransaction`æ–¹æ³•è¿”å›ä¸€ä¸ª`TransactionStatus`å¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰äº‹åŠ¡çš„çŠ¶æ€ã€‚
- åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡`TransactionStatus`å¯¹è±¡æ¥æ£€æŸ¥äº‹åŠ¡çš„çŠ¶æ€ã€‚
- æœ€ç»ˆï¼Œé€šè¿‡è°ƒç”¨`dataSourceTransactionManager`çš„commitæˆ–rollbackæ–¹æ³•æäº¤æˆ–å›æ»šäº‹åŠ¡ã€‚
ä¸‹é¢æ˜¯æ›´ä¸ºå®Œæ•´ã€è§„èŒƒçš„ä»£ç ï¼š
```java
@RestController
@RequestMapping("/user")
public class UserController {

    @Autowired
    private UserService userService;

    @Autowired
    private DataSourceTransactionManager transactionManager;

    @Autowired
    private TransactionDefinition transactionDefinition;

    @RequestMapping("/delete")
    public Integer delete(Integer id){
        if(id == null || id <= 0){
            return 0;
        }

        TransactionStatus transactionStatus = null;
        int result = 0;
        try{
            //å¼€å¯äº‹åŠ¡
            transactionStatus = transactionManager.getTransaction(transactionDefinition);
            //ä¸šåŠ¡æ“ä½œ
            result = userService.delete(id);
            System.out.println("åˆ é™¤ï¼š" + result);
            //æäº¤äº‹åŠ¡
            transactionManager.commit(transactionStatus);
        }catch (Exception e){
            //å›æ»šäº‹åŠ¡
            if(transactionStatus != null){
                transactionManager.rollback(transactionStatus);
            }
        }
        return result;
    }
}
```
ä½†æ˜¯è¿™ç§æ–¹å¼å¤ªç¹çäº†ï¼Œè¿˜æœ‰æ›´ä¸ºç®€å•çš„æ–¹æ³•ğŸ‘‡ã€‚
### å£°æ˜å¼äº‹åŠ¡ï¼ˆæ³¨è§£ï¼‰
ä½¿ç”¨ `@Transactional` æ³¨è§£ï¼š

```java
@RestController
@RequestMapping("/user")
public class UserController {

    @Autowired
    private UserService userService;

    @RequestMapping("/delete2")
    @Transactional
    public Integer delete2(Integer id){
        if(id == null || id <= 0){
            return 0;
        }
        int result = userService.delete(id);
        System.out.println("åˆ é™¤ï¼š" + result);
        return result;
    }
}
```
æ— éœ€æ‰‹åŠ¨å¼€å¯äº‹åŠ¡å’Œæäº¤äº‹åŠ¡ï¼Œè¿›å…¥æ–¹æ³•æ—¶è‡ªåŠ¨å¼€å¯äº‹åŠ¡ï¼Œæ–¹æ³•æ‰§è¡Œå®Œä¼šè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼Œå¦‚æœä¸­é€”å‘ç”Ÿäº†æ²¡æœ‰å¤„ç†çš„å¼‚å¸¸ä¼šè‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚
å¾…åˆ é™¤æ•°æ®çš„è¡¨ï¼Œè¿™é‡Œåˆ é™¤â€œå¼ ä¸‰â€ï¼š

![](img/2024-02-26-12-33-05.png)
è¿›è¡Œè®¿é—®åï¼š

![](img/2024-02-26-12-33-28.png)

![](img/2024-02-26-12-33-54.png)
è¯´æ˜äº‹åŠ¡æäº¤æˆåŠŸã€‚

#### å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™
1. æ²¡æœ‰å¤„ç†çš„å¼‚å¸¸ä¼šè‡ªåŠ¨å›æ»šäº‹åŠ¡
â€ƒâ€ƒä¸‹é¢çš„ä»£ç ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™æ—¶å€™å†çœ‹çœ‹äº‹åŠ¡æ˜¯å¦ä¼šå›æ»šã€‚
```java
@RequestMapping("/delete2")
@Transactional
public Integer delete2(Integer id){
    if(id == null || id <= 0){
        return 0;
    }
    int result = userService.delete(id);
    int x = 8 / 0; //ä¼šæŠ›å‡º ArithmeticException å¼‚å¸¸
    System.out.println("åˆ é™¤ï¼š" + result);
    return result;
}
```

![](img/2024-02-26-12-34-57.png)


![](img/2024-02-26-12-35-15.png)

ä¸­é€”å‘ç”Ÿäº†æ²¡æœ‰å¤„ç†çš„å¼‚å¸¸ä¼šè‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚

2. å¤„ç†åçš„å¼‚å¸¸ä¸ä¼šè‡ªåŠ¨å›æ»šäº‹åŠ¡
```java
@RestController
@RequestMapping("/user")
public class UserController {
    @RequestMapping("/delete2")
    @Transactional
    public Integer delete2(Integer id){
        if(id == null || id <= 0){
            return 0;
        }
        int result = 0;
        try {
            //åˆ é™¤æ•°æ®
            result = userService.delete(id);
            System.out.println("åˆ é™¤ï¼š" + result);
            int x = 8 / 0;
        }catch (Exception e){
            System.out.println(e.getMessage());
        }
        return result;
    }
}
```
è®¿é—®å‰çš„è¡¨ï¼š

![](img/2024-02-26-12-36-15.png)

åˆ é™¤ `id=4`ï¼š

![](img/2024-02-26-12-36-57.png)
è®¿é—®åçš„è¡¨ï¼š

![](img/2024-02-26-12-37-16.png)

å¯ä»¥çœ‹åˆ°å¤„ç†äº†å¼‚å¸¸åï¼Œäº‹åŠ¡æ²¡æœ‰å›æ»šï¼Œè¿™æ ·çš„æ“ä½œéå¸¸çš„å±é™©ï¼Œä½†æ˜¯ä¹Ÿæœ‰è§£å†³çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯æ‰‹åŠ¨å›æ»šäº‹åŠ¡ï¼š

```java
@RequestMapping("/delete2")
@Transactional
public Integer delete2(Integer id){
    if(id == null || id <= 0){
        return 0;
    }
    int result = 0;
    try {
        result = userService.delete(id);
        System.out.println("åˆ é™¤ï¼š" + result);
        int x = 8 / 0;
    }catch (Exception e){
        System.out.println(e.getMessage());
        //æ‰‹åŠ¨å›æ»šäº‹åŠ¡
        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
    }
    return result;
}
```
â€ƒâ€ƒå¯ä»¥çœ‹åˆ°å¤„ç†äº†å¼‚å¸¸åï¼Œäº‹åŠ¡æ²¡æœ‰å›æ»šï¼Œè¿™æ ·çš„æ“ä½œéå¸¸çš„å±é™©ï¼Œä½†æ˜¯ä¹Ÿæœ‰è§£å†³çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯æ‰‹åŠ¨å›æ»šäº‹åŠ¡ï¼š

```java
@RequestMapping("/delete2")
@Transactional
public Integer delete2(Integer id){
    if(id == null || id <= 0){
        return 0;
    }
    int result = 0;
    try {
        result = userService.delete(id);
        System.out.println("åˆ é™¤ï¼š" + result);
        int x = 8 / 0;
    }catch (Exception e){
        System.out.println(e.getMessage());
        //æ‰‹åŠ¨å›æ»šäº‹åŠ¡
        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
    }
    return result;
}
```
è¿™æ ·å®ƒå°±ä¼šå›æ»šäº‹åŠ¡äº†ã€‚

#### @Transactional ä½œç”¨èŒƒå›´
`@Transactional` å¯ä»¥åŠ åœ¨æ–¹æ³•ä¸Šä»¥åŠç±»ä¸Šï¼Œä½†æ˜¯ï¼š

- å½“ä½¿ç”¨ `@Transactional` æ³¨è§£ä¿®é¥°æ–¹æ³•æ—¶ï¼Œå®ƒåªå¯¹`public`çš„æ–¹æ³•ç”Ÿæ•ˆã€‚
- å½“ä½¿ç”¨ `@Transactional` æ³¨è§£ä¿®é¥°ç±»æ—¶ï¼Œè¡¨ç¤ºå¯¹è¯¥ç±»ä¸­æ‰€æœ‰çš„`public`æ–¹æ³•ç”Ÿæ•ˆã€‚
â€ƒâ€ƒè¿™æ˜¯å› ä¸ºåŸºäºä»£ç†çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶åœ¨è¿è¡Œæ—¶åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¹¶ä¸”ä»£ç†å¯¹è±¡åªèƒ½è®¿é—®`public`æ–¹æ³•ã€‚å½“`@Transactional`æ³¨è§£åº”ç”¨äºé`public`æ–¹æ³•ï¼ˆå¦‚`protected`ã€`private`æˆ–é»˜è®¤åŒ…å¯è§æ€§çš„æ–¹æ³•ï¼‰æ—¶ï¼Œä»£ç†å¯¹è±¡æ— æ³•è®¿é—®è¿™äº›æ–¹æ³•ï¼Œå¯¼è‡´äº‹åŠ¡ç®¡ç†æ— æ³•ç”Ÿæ•ˆã€‚

2.2.3 @Transactional å‚æ•°è¯´æ˜
ä¸‹é¢æ˜¯è¡¥å……çš„ `@Transactional` æ³¨è§£çš„å‚æ•°åŠå…¶ä½œç”¨çš„æ±‡æ€»è¡¨æ ¼ï¼š

| å‚æ•° | æè¿° |
| ---- | ---- |
|value | æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨çš„åç§°ã€‚ |
| propagation | æŒ‡å®šäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºã€‚ |
| isolation |   æŒ‡å®šäº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚ |
| readOnly |    æŒ‡å®šäº‹åŠ¡æ˜¯å¦ä¸ºåªè¯»ã€‚ |
| timeout | æŒ‡å®šäº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚ |
| rollbackFor | æŒ‡å®šå“ªäº›å¼‚å¸¸è§¦å‘äº‹åŠ¡å›æ»šã€‚ |
| rollbackForClassName |    æŒ‡å®šå“ªäº›å¼‚å¸¸ç±»åè§¦å‘äº‹åŠ¡å›æ»šã€‚ |
| noRollbackFor |   æŒ‡å®šå“ªäº›å¼‚å¸¸ä¸è§¦å‘äº‹åŠ¡å›æ»šã€‚ |
| noRollbackForClassName |  æŒ‡å®šå“ªäº›å¼‚å¸¸ç±»åä¸è§¦å‘äº‹åŠ¡å›æ»šã€‚ |

1. propagationï¼šæŒ‡å®šäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºï¼ˆåæ–‡è¯¦ç»†ä»‹ç»ï¼‰ã€‚
2. isolationï¼šæŒ‡å®šäº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œå®šä¹‰äº†äº‹åŠ¡ä¹‹é—´çš„å¯è§æ€§å’Œå¹¶å‘æ§åˆ¶ï¼ˆåæ–‡è¯¦ç»†ä»‹ç»ï¼‰ã€‚
3. readOnlyï¼šæŒ‡å®šäº‹åŠ¡æ˜¯å¦ä¸ºåªè¯»ï¼Œå¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™è¡¨ç¤ºè¯¥äº‹åŠ¡åªè¯»å–æ•°æ®ï¼Œä¸ä¿®æ”¹æ•°æ®ã€‚
4. timeoutï¼šæŒ‡å®šäº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœäº‹åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šçš„è¶…æ—¶æ—¶é—´ï¼Œåˆ™äº‹åŠ¡ä¼šè¢«å¼ºåˆ¶å›æ»šã€‚
5. rollbackForï¼šæŒ‡å®šå“ªäº›å¼‚å¸¸è§¦å‘äº‹åŠ¡å›æ»šã€‚å¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå¼‚å¸¸ç±»å‹çš„æ•°ç»„ã€‚
6. rollbackForClassNameï¼šæŒ‡å®šå“ªäº›å¼‚å¸¸ç±»åè§¦å‘äº‹åŠ¡å›æ»šã€‚å¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå¼‚å¸¸ç±»åçš„å­—ç¬¦ä¸²æ•°ç»„ã€‚
7. noRollbackForï¼šæŒ‡å®šå“ªäº›å¼‚å¸¸ä¸è§¦å‘äº‹åŠ¡å›æ»šã€‚å¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå¼‚å¸¸ç±»å‹çš„æ•°ç»„ã€‚
8. noRollbackForClassNameï¼šæŒ‡å®šå“ªäº›å¼‚å¸¸ç±»åä¸è§¦å‘äº‹åŠ¡å›æ»šã€‚å¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå¼‚å¸¸ç±»åçš„å­—ç¬¦ä¸²æ•°ç»„ã€‚

####  @Transactional å·¥ä½œåŸç†
â€ƒâ€ƒSpring é€šè¿‡ä»£ç†æ¨¡å¼å®ç° `@Transactional` çš„å·¥ä½œåŸç†ã€‚å½“ä¸€ä¸ªå¸¦æœ‰ `@Transactional` æ³¨è§£çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒSpring å°†åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡æ¥ç®¡ç†äº‹åŠ¡ã€‚Spring ä½¿ç”¨ AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰å°†äº‹åŠ¡ç®¡ç†é€»è¾‘ç»‡å…¥åˆ°å¸¦æœ‰ @Transactional æ³¨è§£çš„æ–¹æ³•å‘¨å›´ã€‚è¿™æ ·ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå‰åï¼Œä¼šæ’å…¥äº‹åŠ¡ç®¡ç†ç›¸å…³çš„ä»£ç ã€‚

ä¸‹é¢æ˜¯æ–¹æ³•è°ƒç”¨çš„è¯¦ç»†è¿‡ç¨‹ï¼š

1. è°ƒç”¨è€…é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨è¢«ä»£ç†çš„æ–¹æ³•ã€‚
2. ä»£ç†å¯¹è±¡æ¥æ”¶åˆ°æ–¹æ³•è°ƒç”¨è¯·æ±‚ã€‚
3. ä»£ç†å¯¹è±¡åœ¨æ–¹æ³•è°ƒç”¨å‰æ‰§è¡Œé¢„å®šä¹‰çš„é€»è¾‘ï¼Œä¾‹å¦‚äº‹åŠ¡ç®¡ç†çš„å¼€å§‹ã€‚
4. ä»£ç†å¯¹è±¡å°†å®é™…çš„æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™åŸå¯¹è±¡ã€‚è¿™æ„å‘³ç€ä»£ç†å¯¹è±¡å°†çœŸæ­£çš„æ–¹æ³•è°ƒç”¨ä¼ é€’ç»™åŸå¯¹è±¡ï¼Œä½¿åŸå¯¹è±¡æ‰§è¡Œå®é™…çš„ä¸šåŠ¡é€»è¾‘ã€‚
5. åŸå¯¹è±¡æ‰§è¡Œæ–¹æ³•çš„å®é™…é€»è¾‘ã€‚
6. åŸå¯¹è±¡è¿”å›æ–¹æ³•çš„ç»“æœç»™ä»£ç†å¯¹è±¡ã€‚
7. ä»£ç†å¯¹è±¡åœ¨æ–¹æ³•è°ƒç”¨åæ‰§è¡Œé¢å¤–çš„é€»è¾‘ï¼Œä¾‹å¦‚äº‹åŠ¡ç®¡ç†çš„æäº¤æˆ–å›æ»šã€‚
8. ä»£ç†å¯¹è±¡å°†æ–¹æ³•çš„ç»“æœè¿”å›ç»™è°ƒç”¨è€…ã€‚

![](img/2024-02-26-12-48-19.png)

## äº‹åŠ¡çš„éš”ç¦»çº§åˆ«
### äº‹åŠ¡ç‰¹æ€§
äº‹åŠ¡å…·æœ‰ä»¥ä¸‹å››ä¸ªé‡è¦çš„ç‰¹æ€§ï¼Œé€šå¸¸è¢«ç§°ä¸º ACID ç‰¹æ€§ï¼š

- åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šåŸå­æ€§è¦æ±‚äº‹åŠ¡è¢«è§†ä¸ºä¸å¯åˆ†å‰²çš„æœ€å°å·¥ä½œå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æˆ–ä¸­æ–­ï¼Œç³»ç»Ÿå¿…é¡»èƒ½å¤Ÿå°†å…¶æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚
- ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šä¸€è‡´æ€§ç¡®ä¿äº‹åŠ¡åœ¨æ‰§è¡Œå‰åæ•°æ®åº“çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æ•°æ®åº“è¿›è¡Œçš„ä¿®æ”¹å¿…é¡»æ»¡è¶³é¢„å®šä¹‰çš„è§„åˆ™å’Œçº¦æŸï¼Œä»¥ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚
- éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šéš”ç¦»æ€§æŒ‡å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çš„æ“ä½œéƒ½åº”å½“ä¸å…¶ä»–äº‹åŠ¡ç›¸äº’éš”ç¦»ï¼Œä½¿å®ƒä»¬æ„Ÿè§‰ä¸åˆ°å…¶ä»–äº‹åŠ¡çš„å­˜åœ¨ã€‚éš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¹¶å‘æ‰§è¡Œçš„äº‹åŠ¡ä¹‹é—´å‘ç”Ÿå¹²æ‰°å’Œæ•°æ®å†²çªï¼Œç¡®ä¿æ•°æ®çš„æ­£ç¡®æ€§ã€‚
- æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šæŒä¹…æ€§è¦æ±‚äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå…¶å¯¹æ•°æ®åº“çš„ä¿®æ”¹å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä½¿åœ¨ç³»ç»Ÿå‘ç”Ÿæ•…éšœæˆ–é‡å¯çš„æƒ…å†µä¸‹ï¼Œä¿®æ”¹çš„æ•°æ®ä¹Ÿèƒ½å¤Ÿè¢«æ¢å¤ã€‚æŒä¹…æ€§é€šè¿‡å°†äº‹åŠ¡çš„ç»“æœå†™å…¥éæ˜“å¤±æ€§å­˜å‚¨ä»‹è´¨ï¼ˆå¦‚ç£ç›˜ï¼‰æ¥å®ç°ã€‚
### äº‹åŠ¡çš„éš”ç¦»çº§åˆ«
å¯¹äºéš”ç¦»æ€§ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹å››ä¸ªæ ‡å‡†çš„éš”ç¦»çº§åˆ«ï¼š

- Read Uncommittedï¼ˆè¯»å–æœªæäº¤æ•°æ®ï¼‰ï¼šæœ€ä½çš„éš”ç¦»çº§åˆ«ã€‚åœ¨è¯¥çº§åˆ«ä¸‹ï¼Œä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–åˆ°å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´è„è¯»ï¼Œå³è¯»å–åˆ°äº†æœªç»éªŒè¯çš„æ•°æ®ã€‚è¿™ä¸ªçº§åˆ«ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ï¼Œå¹¶ä¸”ä¸æä¾›ä»»ä½•å¹¶å‘æ§åˆ¶ã€‚
- Read Committedï¼ˆè¯»å–å·²æäº¤æ•°æ®ï¼‰ï¼šåœ¨è¯¥çº§åˆ«ä¸‹ï¼Œä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–åˆ°å·²ç»æäº¤çš„æ•°æ®ã€‚å®ƒé¿å…äº†è„è¯»ï¼Œä½†å¯èƒ½å‡ºç°ä¸å¯é‡å¤è¯»ï¼ˆNon-repeatable Readï¼‰çš„é—®é¢˜ã€‚ä¸å¯é‡å¤è¯»æ˜¯æŒ‡åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¯¥æ•°æ®è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ï¼Œå¯¼è‡´æ¯æ¬¡è¯»å–åˆ°çš„å€¼ä¸ä¸€è‡´ã€‚
- Repeatable Readï¼ˆå¯é‡å¤è¯»ï¼‰ï¼šåœ¨è¯¥çº§åˆ«ä¸‹ï¼Œä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®æ—¶ï¼Œä¿è¯èƒ½å¤Ÿè¯»å–åˆ°ä¸€è‡´çš„ç»“æœã€‚å³ä½¿å…¶ä»–äº‹åŠ¡å¯¹è¯¥æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œä¹Ÿä¸ä¼šå½±å“å½“å‰äº‹åŠ¡çš„è¯»å–æ“ä½œã€‚è¿™ä¸ªçº§åˆ«é€šè¿‡é”å®šè¯»å–çš„æ•°æ®ï¼Œé¿å…äº†ä¸å¯é‡å¤è¯»ï¼Œä½†å¯èƒ½å‡ºç°å¹»è¯»ï¼ˆPhantom Readï¼‰çš„é—®é¢˜ã€‚å¹»è¯»æ˜¯æŒ‡åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´çš„æ•°æ®æ—¶ï¼Œç”±äºå…¶ä»–äº‹åŠ¡æ’å…¥äº†æ–°çš„æ•°æ®ï¼Œå¯¼è‡´æ¯æ¬¡æŸ¥è¯¢ç»“æœé›†ä¸ä¸€è‡´ã€‚
- Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰ï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®ƒè¦æ±‚äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®Œå…¨é¿å…äº†å¹¶å‘é—®é¢˜ã€‚åœ¨è¯¥çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡ä¹‹é—´äº’ç›¸çœ‹ä¸åˆ°å¯¹æ–¹çš„æ“ä½œï¼Œå¯ä»¥é¿å…è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ç­‰é—®é¢˜ã€‚ç„¶è€Œï¼Œç”±äºä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œä¼šç‰ºç‰²ä¸€å®šçš„å¹¶å‘æ€§èƒ½ã€‚
### Spring ä¸­è®¾ç½®éš”ç¦»çº§åˆ«
åœ¨Springä¸­ï¼Œå¯ä»¥ä½¿ç”¨`@Transactional`æ³¨è§£è®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚Springæä¾›äº†ä¸æ•°æ®åº“äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹åº”çš„äº”ä¸ªå¸¸é‡ï¼š

- DEFAULTï¼šä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚
- READ_UNCOMMITTEDï¼šå¯¹åº”æ•°æ®åº“çš„è¯»å–æœªæäº¤æ•°æ®ï¼ˆRead Uncommittedï¼‰éš”ç¦»çº§åˆ«ã€‚
- READ_COMMITTEDï¼šå¯¹åº”æ•°æ®åº“çš„è¯»å–å·²æäº¤æ•°æ®ï¼ˆRead Committedï¼‰éš”ç¦»çº§åˆ«ã€‚
- REPEATABLE_READï¼šå¯¹åº”æ•°æ®åº“çš„å¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰éš”ç¦»çº§åˆ«ã€‚
- SERIALIZABLEï¼šå¯¹åº”æ•°æ®åº“çš„å¯ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰éš”ç¦»çº§åˆ«ã€‚
ä½¿ç”¨@Transactionalæ³¨è§£æ—¶ï¼Œå¯ä»¥é€šè¿‡isolationå±æ€§æŒ‡å®šäº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚ä¾‹å¦‚ï¼š
```java
@Transactional(isolation = Isolation.READ_COMMITTED)
public void myMethod() {
    // äº‹åŠ¡å¤„ç†é€»è¾‘
}
```


![](img/2024-02-26-12-52-08.png)

## Spring äº‹åŠ¡ä¼ æ’­æœºåˆ¶
### ä»€ä¹ˆæ˜¯äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶ï¼Ÿ
äº‹åŠ¡ä¼ æ’­æœºåˆ¶æ˜¯æŒ‡å®šäº‹åŠ¡åœ¨æ–¹æ³•è°ƒç”¨ä¹‹é—´å¦‚ä½•ä¼ æ’­å’Œå½±å“çš„æœºåˆ¶ï¼Œé€šè¿‡å®šä¹‰äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºï¼Œ**æ§åˆ¶äº‹åŠ¡åœ¨ä¸åŒæ–¹æ³•ä¹‹é—´çš„åˆ›å»ºã€æŒ‚èµ·ã€æ¢å¤å’Œå›æ»šæ“ä½œã€‚**

![](img/2024-02-26-12-56-17.png)

â€ƒâ€ƒä¸‹é¢æ˜¯å¸¸è§çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼š

- REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥åˆ°å½“å‰äº‹åŠ¡ä¸­ï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚
- SUPPORTSï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥åˆ°å½“å‰äº‹åŠ¡ä¸­ï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼æ‰§è¡Œã€‚
- MANDATORYï¼šå¿…é¡»åœ¨ä¸€ä¸ªå·²å­˜åœ¨çš„äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
- REQUIRES_NEWï¼šæ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™å°†å½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚
- NOT_SUPPORTEDï¼šä»¥éäº‹åŠ¡çš„æ–¹å¼æ‰§è¡Œæ“ä½œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™å°†å½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚
- NEVERï¼šå¿…é¡»ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
- NESTEDï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚
"å½“å‰å­˜åœ¨äº‹åŠ¡"æŒ‡çš„æ˜¯åœ¨æ–¹æ³•è°ƒç”¨æœŸé—´å·²ç»å¼€å¯çš„äº‹åŠ¡ã€‚åœ¨Springä¸­ï¼Œäº‹åŠ¡æ˜¯åŸºäºçº¿ç¨‹çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚å¦‚æœåœ¨æ–¹æ³•è°ƒç”¨æœŸé—´å·²ç»å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ï¼ˆå³å·²ç»å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼‰ï¼Œåˆ™å¯ä»¥è¯´"å½“å‰å­˜åœ¨äº‹åŠ¡"ã€‚

å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒSpringä¼šæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»æœ‰ä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡å­˜åœ¨ã€‚å¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±å¯ä»¥åœ¨è¿™ä¸ªå·²å­˜åœ¨çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå³åœ¨å½“å‰äº‹åŠ¡ä¸­æ‰§è¡Œã€‚æ–¹æ³•å¯ä»¥è®¿é—®å’Œæ“ä½œå½“å‰äº‹åŠ¡ä¸­çš„æ•°æ®ï¼Œå¹¶å…±äº«è¯¥äº‹åŠ¡çš„ä¸€è‡´æ€§å’Œéš”ç¦»çº§åˆ«ï¼ˆå–å†³äºæ–¹æ³•çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºè®¾ç½®ï¼‰ã€‚

å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰äº‹åŠ¡ä¸Šä¸‹æ–‡å­˜åœ¨ï¼Œé‚£ä¹ˆæ–¹æ³•å¯ä»¥é€‰æ‹©åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œæˆ–è€…ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚è¿™å–å†³äºæ–¹æ³•çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºè®¾ç½®ã€‚æ–°çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ä¼šåœ¨æ–¹æ³•å¼€å§‹æ—¶åˆ›å»ºï¼Œå¹¶åœ¨æ–¹æ³•æ‰§è¡Œå®Œæ¯•åè¿›è¡Œæäº¤æˆ–å›æ»šã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ªæ–¹æ³•Aå†…éƒ¨è°ƒç”¨äº†å¦ä¸€ä¸ªæ–¹æ³•Bï¼Œå¦‚æœæ–¹æ³•Bå…·æœ‰REQUIREDï¼ˆé»˜è®¤ï¼‰çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œè€Œæ–¹æ³•Aå·²ç»åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆæ–¹æ³•Bå°†åŠ å…¥åˆ°æ–¹æ³•Açš„äº‹åŠ¡ä¸­ï¼Œå…±åŒå‚ä¸äº‹åŠ¡çš„æ“ä½œã€‚

![](img/2024-02-26-12-56-50.png)


### äº‹åŠ¡ä¼ æ’­æœºåˆ¶çš„æ¼”ç¤º
æœ¬ç¯‡åªæ¼”ç¤ºä¸€éƒ¨åˆ†ã€‚

#### å‡†å¤‡å·¥ä½œ
åœ¨æ¼”ç¤ºä¹‹å‰ï¼Œè¿™é‡Œå…ˆåˆ›å»ºä¸¤å¼ è¡¨ï¼Œä»¥æ–¹ä¾¿æˆ‘ä»¬çœ‹å‡ºå®ƒä»¬çš„ä½œç”¨ã€‚

![](img/2024-02-26-12-59-17.png)

![](img/2024-02-26-12-59-35.png)

æ’å…¥çš„æ•°æ®ï¼š
![](img/2024-02-26-12-59-58.png)

log è¡¨ä¸ºç©ºï¼š

![](img/2024-02-26-13-01-20.png)

å®šä¹‰3ä¸ªç±»ï¼š

```java
@RestController
@RequestMapping("/user3")
public class UserController3 {

    @Autowired
    private UserService userService;

    // REQUIRED ç±»å‹
    @RequestMapping("/add")
    @Transactional(propagation = Propagation.REQUIRED)
    public int add(String username,String password){
        if(username == null || password == null || username.equals("") || password.equals("")){
            return 0;
        }
        UserInfo userInfo = new UserInfo();
        userInfo.setUsername(username);
        userInfo.setPassword(password);
        int result = userService.add(userInfo);
        return result;
    }
}
```

```java
@Service
public class UserService {
    @Autowired
    private UserMapper userMapper;

    @Autowired
    private LogService logService;

    public Integer delete(int id){
        return userMapper.delete(id);
    }

    // REQUIRED ç±»å‹
    //æ·»åŠ ç”¨æˆ·
    @Transactional(propagation = Propagation.REQUIRED)
    public Integer add(UserInfo userInfo){
        //ç»™ç”¨æˆ·è¡¨æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        int addUserResult = userMapper.add(userInfo);
        System.out.println("æ·»åŠ ç”¨æˆ·ç»“æœï¼š" + addUserResult);
        Log log = new Log();
        log.setMessage("æ·»åŠ æ—¥å¿—ä¿¡æ¯");
        logService.add(log);
        return 0;
    }
}
```

```java
@Service
public class LogService {

    @Autowired
    private LogMapper logMapper;
    
    //æ·»åŠ æ—¥å¿—ä¿¡æ¯
	// REQUIRED ç±»å‹
    @Transactional(propagation = Propagation.REQUIRED)
    public Integer add(Log log){
        int result = logMapper.add(log);
        System.out.println("æ·»åŠ æ—¥å¿—çš„ç»“æœï¼š" + result);
        //å›æ»šäº‹åŠ¡ï¼Œæ¨¡ä»¿å‘ç”Ÿå¼‚å¸¸ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸å†™ä¸€ä¸ªå¼‚å¸¸å‘¢ï¼Ÿå› ä¸ºå¼‚å¸¸ä¼šä¼ é€’åˆ°å¤–é¢çš„æ–¹æ³•ã€‚
        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
        return result;
    }
}
```

#### REQUIRED æ¼”ç¤º
è°ƒç”¨å…³ç³»ï¼š

![](img/2024-02-26-13-03-56.png)

ä¼ å…¥ä»¥ä¸‹çš„å€¼ï¼š

![](img/2024-02-26-13-04-25.png)

![](img/2024-02-26-13-04-38.png)

å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªè¡¨éƒ½æ˜¯æ·»åŠ æˆåŠŸçš„ï¼Œä½†æ˜¯LogServiceä¸­çš„addæ–¹æ³•å›æ»šäº†ï¼Œé‡ç‚¹çœ‹å…¶å®ƒæ–¹æ³•å›æ»šäº†æ²¡æœ‰ï¼š

![](img/2024-02-26-13-04-59.png)

è¿™ä¸¤ä¸ªè¡¨æ²¡æœ‰å˜åŒ–ï¼Œè¯´æ˜æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯å›æ»šäº†çš„ã€‚è¿™å°±ä½“ç°äº†REQUIREDè¿™ä¸ªä¼ æ’­è¡Œä¸ºï¼Œä¸€ä¸ªæ–¹æ³•å›æ»šäº†ï¼Œå…¶å®ƒæ‰€æœ‰æ–¹æ³•éƒ½å›æ»šã€‚

æ›´å…·ä½“çš„ï¼š`LogService`ä¸­çš„`add`æ–¹æ³•æœ¬èº«æœ‰äº‹åŠ¡ï¼Œ`UserService`ä¸­çš„`add`æ–¹æ³•ä¹Ÿæ˜¯`REQUIRED`ã€‚è¿™æ—¶å€™ï¼Œ`LogService`ä¸­çš„`add`å°±åŠ å…¥äº†`UserService`ä¸­çš„äº‹åŠ¡ï¼Œç›¸å½“äºä¸€ä¸ªæ•´ä½“ã€‚
#### REQUIRES_NEW æ¼”ç¤º
å°†æ–¹æ³•éƒ½æ”¹ä¸ºREQUIRES_NEWï¼Œæ–¹æ³•è°ƒç”¨è·Ÿä¸Šé¢ä¸€æ ·ã€‚

```java
@RequestMapping("/add")
@Transactional(propagation = Propagation.REQUIRES_NEW)
public int add(String username,String password){
    if(username == null || password == null || username.equals("") || password.equals("")){
        return 0;
    }
    UserInfo userInfo = new UserInfo();
    userInfo.setUsername(username);
    userInfo.setPassword(password);
    int result = userService.add(userInfo);
    return result;
}
```

```java
//æ·»åŠ ç”¨æˆ·
@Transactional(propagation = Propagation.REQUIRES_NEW)
public Integer add(UserInfo userInfo){
    //ç»™ç”¨æˆ·è¡¨æ·»åŠ ç”¨æˆ·ä¿¡æ¯
    int addUserResult = userMapper.add(userInfo);
    System.out.println("æ·»åŠ ç”¨æˆ·ç»“æœï¼š" + addUserResult);
    Log log = new Log();
    log.setMessage("æ·»åŠ æ—¥å¿—ä¿¡æ¯");
    logService.add(log);
    return 0;
}
```


```java
@Transactional(propagation = Propagation.REQUIRES_NEW)
public Integer add(Log log){
    int result = logMapper.add(log);
    System.out.println("æ·»åŠ æ—¥å¿—çš„ç»“æœï¼š" + result);
    //å›æ»šäº‹åŠ¡ï¼Œæ¨¡ä»¿å‘ç”Ÿå¼‚å¸¸ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸å†™ä¸€ä¸ªå¼‚å¸¸å‘¢ï¼Ÿå› ä¸ºå¼‚å¸¸ä¼šä¼ é€’åˆ°å¤–é¢çš„æ–¹æ³•ã€‚
    TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
    return result;
}
```

å‘é€è¯·æ±‚ï¼š

![](img/2024-02-26-13-07-18.png)

ç»“æœï¼š

![](img/2024-02-26-13-08-42.png)

`UserService`ä¸­`add`æ–¹æ³•çš„äº‹åŠ¡æ²¡æœ‰å›æ»šï¼Œ`LogService`ä¸­çš„äº‹åŠ¡å›æ»šäº†ï¼Œå›å¿†`REQUIRES_NEW`ï¼šæ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œ
å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™å°†å½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚åœ¨è¿™é‡Œï¼Œ`LogService`ä¸­çš„äº‹åŠ¡å…ˆæ‰§è¡Œï¼Œæ‰§è¡Œå®Œåå†æ‰§è¡Œ`UserService`ä¸­çš„äº‹åŠ¡ã€‚
#### NESTEDï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰æ¼”ç¤º

åŒæ ·çš„ï¼ŒæŠŠ`@Transactional`æ”¹ä¸º`NESTED`ã€‚
è¯·æ±‚ï¼š

![](img/2024-02-26-13-10-52.png)

æ•°æ®åº“ä¸­çš„è¡¨ï¼š

![](img/2024-02-26-13-11-09.png)

`LogService`ä¸­çš„äº‹åŠ¡å·²ç»å›æ»šï¼Œä½†æ˜¯åµŒå¥—äº‹åŠ¡ä¸ä¼šå›æ»šåµŒå¥—ä¹‹å‰çš„äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´åµŒå¥—äº‹åŠ¡å¯ä»¥å®ç°éƒ¨åˆ†äº‹åŠ¡å›æ»šï¼Œ
ä½†æ˜¯è¿™ä¸ä¸Šé¢çš„`REQUIRES_NEW`æ˜¯ä¸€æ ·çš„æ•ˆæœå‘€ï¼Œå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ

#### NESTEDï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰ä¸ REQUIRES_NEWçš„åŒºåˆ«
- `NESTED`ï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰ï¼š

åœ¨åµŒå¥—äº‹åŠ¡ä¸­ï¼Œ**å†…éƒ¨äº‹åŠ¡å®é™…ä¸Šæ˜¯ç”±å¤–éƒ¨äº‹åŠ¡å¼€å¯å’Œæäº¤/å›æ»šçš„ã€‚** å½“å¤–éƒ¨äº‹åŠ¡å›æ»šæ—¶ï¼Œä¼šå¯¼è‡´å†…éƒ¨äº‹åŠ¡ä¹Ÿè¢«å›æ»šï¼Œå³ä½¿å†…éƒ¨äº‹åŠ¡å·²ç»æ‰§è¡Œäº†ä¸€äº›æäº¤æ“ä½œã€‚ â€ƒâ€ƒè¿™æ˜¯å› ä¸ºåµŒå¥—äº‹åŠ¡çš„æ¨¡æ‹Ÿé€šè¿‡ä¿å­˜å’Œæ¢å¤äº‹åŠ¡çŠ¶æ€æ¥å®ç°ï¼Œå½“å¤–éƒ¨äº‹åŠ¡å›æ»šæ—¶ï¼Œå®ƒä¼šå›æ»šåˆ°å¼€å¯å†…éƒ¨äº‹åŠ¡çš„é‚£ä¸ªç‚¹ï¼ŒåŒ…æ‹¬å†…éƒ¨äº‹åŠ¡æ‰§è¡Œçš„ä»»ä½•ä¿®æ”¹æˆ–æäº¤ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚

- `REQUIRES_NEW`ï¼š

`REQUIRES_NEW`è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ã€‚å½“ä¸€ä¸ªäº‹åŠ¡ï¼ˆå¤–éƒ¨äº‹åŠ¡ï¼‰è°ƒç”¨å¦ä¸€ä¸ªå¸¦æœ‰REQUIRES_NEWä¼ æ’­è¡Œä¸ºçš„äº‹åŠ¡æ—¶ï¼Œå†…éƒ¨äº‹åŠ¡å°†åœ¨ä¸€ä¸ªæ–°çš„äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œç‹¬ç«‹äºå¤–éƒ¨äº‹åŠ¡ã€‚å†…éƒ¨äº‹åŠ¡çš„æäº¤æˆ–å›æ»šä¸ä¼šå½±å“å¤–éƒ¨äº‹åŠ¡ã€‚æ— è®ºå¤–éƒ¨äº‹åŠ¡æ˜¯å¦å›æ»šï¼Œå†…éƒ¨äº‹åŠ¡éƒ½å¯ä»¥ç‹¬ç«‹æäº¤æˆ–å›æ»šã€‚

### åµŒå¥—äº‹åŠ¡å’ŒåŠ å…¥äº‹åŠ¡çš„åŒºåˆ«
- åµŒå¥—äº‹åŠ¡ï¼ˆNested Transactionsï¼‰ï¼š **åµŒå¥—äº‹åŠ¡æ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨å¼€å¯äº†å¦ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡**ã€‚
åµŒå¥—äº‹åŠ¡å¯ä»¥åœ¨çˆ¶äº‹åŠ¡çš„èŒƒå›´å†…æ‰§è¡Œï¼Œ**å¹¶ä¸”å…·æœ‰ç‹¬ç«‹çš„äº‹åŠ¡æ—¥å¿—å’Œå›æ»šæœºåˆ¶**ã€‚ åµŒå¥—äº‹åŠ¡å…è®¸åœ¨çˆ¶äº‹åŠ¡ä¸­è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ“ä½œå’Œæ§åˆ¶ï¼Œä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªé•¿äº‹åŠ¡ä¸­çš„æŸä¸ªæ­¥éª¤ä¸­å¼€å¯äº†ä¸€ä¸ªå­äº‹åŠ¡ï¼Œå­äº‹åŠ¡å¯ä»¥ç‹¬ç«‹æäº¤æˆ–å›æ»šï¼Œè€Œä¸ä¼šå½±å“çˆ¶äº‹åŠ¡çš„å…¶ä»–æ­¥éª¤ã€‚åµŒå¥—äº‹åŠ¡é€šå¸¸ç”¨äºå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¯ä»¥æä¾›æ›´çµæ´»çš„äº‹åŠ¡å¤„ç†ã€‚
- åŠ å…¥äº‹åŠ¡ï¼ˆJoin Transactionsï¼‰ï¼š **åŠ å…¥äº‹åŠ¡æ˜¯æŒ‡å°†ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡åˆå¹¶åˆ°å½“å‰äº‹åŠ¡ä¸­ï¼Œä½¿å®ƒä»¬æˆä¸ºä¸€ä¸ªæ•´ä½“**ã€‚
åŠ å…¥äº‹åŠ¡å¯ä»¥å°†å¤šä¸ªäº‹åŠ¡åˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§çš„äº‹åŠ¡ï¼Œç¡®ä¿å®ƒä»¬ä½œä¸ºä¸€ä¸ªåŸå­æ“ä½œè¿›è¡Œæäº¤æˆ–å›æ»šã€‚åŠ å…¥äº‹åŠ¡é€šå¸¸ç”¨äºå¤šä¸ªç‹¬ç«‹äº‹åŠ¡ä¹‹é—´å­˜åœ¨é€»è¾‘ä¸Šçš„ä¾èµ–å…³ç³»ï¼Œéœ€è¦ä»¥ä¸€è‡´çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚é€šè¿‡å°†å¤šä¸ªäº‹åŠ¡åŠ å…¥åˆ°ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¯ä»¥ä¿è¯å®ƒä»¬çš„ä¸€è‡´æ€§ï¼Œ**å¹¶ä¸”è¦ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šã€‚**
